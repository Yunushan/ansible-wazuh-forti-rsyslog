<!-- Ansible managed: Fortinet high/critical alerts -->
<group name="fortinet,">
{% set forti_wazuh_ssl_vpn_fail_match_list = forti_wazuh_ssl_vpn_fail_match | default([]) %}
{% set forti_wazuh_ssl_vpn_suppress_map = (forti_wazuh_ssl_vpn_fail_manage | bool) and (forti_wazuh_ssl_vpn_fail_match_list | length > 0) %}
{% set forti_wazuh_ssl_vpn_fail_base_level_effective = [forti_wazuh_ssl_vpn_fail_base_level | int, 1] | max %}
{% set forti_wazuh_fortinet_alerts_decoded_as_effective = forti_wazuh_fortinet_alerts_decoded_as | default('') | string | trim %}
{% set forti_wazuh_fortinet_alerts_use_decoded_fields_effective = forti_wazuh_fortinet_alerts_use_decoded_fields | default(true, true) | bool %}
{% set forti_wazuh_fortinet_alerts_match_field_name = forti_wazuh_fortinet_alerts_match_field_effective | string | trim %}
{% set forti_wazuh_fortinet_alerts_match_via_field = forti_wazuh_fortinet_alerts_use_decoded_fields_effective and forti_wazuh_fortinet_alerts_match_field_name in ['level','crlevel'] %}
{% if forti_wazuh_fortinet_alerts_map_effective | length > 0 %}
{% for item in forti_wazuh_fortinet_alerts_map_effective %}
  <rule id="{{ (forti_wazuh_fortinet_alerts_rule_id_base | int) + (loop.index0 * 2) }}" level="{{ item.level | int }}">
{% if forti_wazuh_fortinet_alerts_decoded_as_effective | length > 0 %}
    <decoded_as>{{ forti_wazuh_fortinet_alerts_decoded_as_effective }}</decoded_as>
{% endif %}
{% if forti_wazuh_fortinet_alerts_match_via_field %}
    <field name="data.{{ forti_wazuh_fortinet_alerts_match_field_name }}">{{ item.match | string }}</field>
{% else %}
    <match>\b{{ forti_wazuh_fortinet_alerts_match_field_effective }}={{ item.match | string }}</match>
{% endif %}
{% if forti_wazuh_ssl_vpn_suppress_map %}
{% for match in forti_wazuh_ssl_vpn_fail_match_list %}
    <match negate="yes">{{ match }}</match>
{% endfor %}
{% endif %}
    <description>Fortinet alert level {{ item.level | int }}</description>
  </rule>
  <rule id="{{ (forti_wazuh_fortinet_alerts_rule_id_base | int) + (loop.index0 * 2) + 1 }}" level="{{ item.level | int }}">
{% if forti_wazuh_fortinet_alerts_decoded_as_effective | length > 0 %}
    <decoded_as>{{ forti_wazuh_fortinet_alerts_decoded_as_effective }}</decoded_as>
{% endif %}
{% if forti_wazuh_fortinet_alerts_match_via_field %}
    <field name="data.{{ forti_wazuh_fortinet_alerts_match_field_name }}">{{ item.match | string }}</field>
{% else %}
    <match>\b{{ forti_wazuh_fortinet_alerts_match_field_effective }}="{{ item.match | string }}"</match>
{% endif %}
{% if forti_wazuh_ssl_vpn_suppress_map %}
{% for match in forti_wazuh_ssl_vpn_fail_match_list %}
    <match negate="yes">{{ match }}</match>
{% endfor %}
{% endif %}
    <description>Fortinet alert level {{ item.level | int }}</description>
  </rule>
{% endfor %}
{% else %}
{% for level in forti_wazuh_fortinet_alerts_levels_effective %}
  <rule id="{{ (forti_wazuh_fortinet_alerts_rule_id_base | int) + (loop.index0 * 2) }}" level="{{ level | int }}">
{% if forti_wazuh_fortinet_alerts_decoded_as_effective | length > 0 %}
    <decoded_as>{{ forti_wazuh_fortinet_alerts_decoded_as_effective }}</decoded_as>
{% endif %}
{% if forti_wazuh_fortinet_alerts_match_via_field %}
    <field name="data.{{ forti_wazuh_fortinet_alerts_match_field_name }}">{{ level }}</field>
{% else %}
    <match>\b{{ forti_wazuh_fortinet_alerts_match_field_effective }}={{ level }}</match>
{% endif %}
{% if forti_wazuh_ssl_vpn_suppress_map %}
{% for match in forti_wazuh_ssl_vpn_fail_match_list %}
    <match negate="yes">{{ match }}</match>
{% endfor %}
{% endif %}
    <description>Fortinet alert level {{ level | int }}</description>
  </rule>
  <rule id="{{ (forti_wazuh_fortinet_alerts_rule_id_base | int) + (loop.index0 * 2) + 1 }}" level="{{ level | int }}">
{% if forti_wazuh_fortinet_alerts_decoded_as_effective | length > 0 %}
    <decoded_as>{{ forti_wazuh_fortinet_alerts_decoded_as_effective }}</decoded_as>
{% endif %}
{% if forti_wazuh_fortinet_alerts_match_via_field %}
    <field name="data.{{ forti_wazuh_fortinet_alerts_match_field_name }}">{{ level }}</field>
{% else %}
    <match>\b{{ forti_wazuh_fortinet_alerts_match_field_effective }}="{{ level }}"</match>
{% endif %}
{% if forti_wazuh_ssl_vpn_suppress_map %}
{% for match in forti_wazuh_ssl_vpn_fail_match_list %}
    <match negate="yes">{{ match }}</match>
{% endfor %}
{% endif %}
    <description>Fortinet alert level {{ level | int }}</description>
  </rule>
{% endfor %}
{% endif %}
{% if forti_wazuh_ssl_vpn_fail_manage | bool %}
  <rule id="{{ forti_wazuh_ssl_vpn_fail_rule_id_base | int }}" level="{{ forti_wazuh_ssl_vpn_fail_base_level_effective | int }}" noalert="1">
{% if forti_wazuh_fortinet_alerts_decoded_as_effective | length > 0 %}
    <decoded_as>{{ forti_wazuh_fortinet_alerts_decoded_as_effective }}</decoded_as>
{% endif %}
{% for match in forti_wazuh_ssl_vpn_fail_match_list %}
    <match>{{ match }}</match>
{% endfor %}
    <description>Fortinet SSL VPN login fail (suppressed)</description>
  </rule>
{% if forti_wazuh_fortinet_alerts_manage_effective | bool %}
{% set sidns = namespace(list=[]) %}
{% if forti_wazuh_fortinet_alerts_map_effective | length > 0 %}
{% for item in forti_wazuh_fortinet_alerts_map_effective %}
{% set sidns.list = sidns.list + [(forti_wazuh_fortinet_alerts_rule_id_base | int) + (loop.index0 * 2), (forti_wazuh_fortinet_alerts_rule_id_base | int) + (loop.index0 * 2) + 1] %}
{% endfor %}
{% else %}
{% for level in forti_wazuh_fortinet_alerts_levels_effective %}
{% set sidns.list = sidns.list + [(forti_wazuh_fortinet_alerts_rule_id_base | int) + (loop.index0 * 2), (forti_wazuh_fortinet_alerts_rule_id_base | int) + (loop.index0 * 2) + 1] %}
{% endfor %}
{% endif %}
{% if sidns.list | length > 0 %}
  <rule id="{{ (forti_wazuh_ssl_vpn_fail_rule_id_base | int) + 2 }}" level="0" noalert="1">
{% if forti_wazuh_fortinet_alerts_decoded_as_effective | length > 0 %}
    <decoded_as>{{ forti_wazuh_fortinet_alerts_decoded_as_effective }}</decoded_as>
{% endif %}
    <if_sid>{{ sidns.list | join(',') }}</if_sid>
{% for match in forti_wazuh_ssl_vpn_fail_match_list %}
    <match>{{ match }}</match>
{% endfor %}
    <description>Fortinet SSL VPN login fail (suppressed from level mapping)</description>
  </rule>
{% endif %}
{% endif %}
  <rule id="{{ (forti_wazuh_ssl_vpn_fail_rule_id_base | int) + 1 }}" level="{{ forti_wazuh_ssl_vpn_fail_level | int }}" frequency="{{ forti_wazuh_ssl_vpn_fail_frequency | int }}" timeframe="{{ forti_wazuh_ssl_vpn_fail_timeframe | int }}">
{% if forti_wazuh_fortinet_alerts_decoded_as_effective | length > 0 %}
    <decoded_as>{{ forti_wazuh_fortinet_alerts_decoded_as_effective }}</decoded_as>
{% endif %}
    <if_matched_sid>{{ forti_wazuh_ssl_vpn_fail_rule_id_base | int }}</if_matched_sid>
{% if forti_wazuh_ssl_vpn_fail_same_field | default('') | trim | length > 0 %}
    <same_field>{{ forti_wazuh_ssl_vpn_fail_same_field }}</same_field>
{% endif %}
    <description>Fortinet SSL VPN login fail ({{ forti_wazuh_ssl_vpn_fail_frequency | int }}+ in {{ forti_wazuh_ssl_vpn_fail_timeframe | int }}s)</description>
  </rule>
{% endif %}
</group>
