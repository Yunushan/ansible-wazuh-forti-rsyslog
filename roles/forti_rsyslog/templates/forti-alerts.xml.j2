<!-- Ansible managed: Fortinet high/critical alerts -->
<group name="fortinet,">
{% set forti_wazuh_ssl_vpn_suppress_map = (forti_wazuh_ssl_vpn_fail_manage | bool) and ((forti_wazuh_ssl_vpn_fail_match | default([])) | length > 0) %}
{% if forti_wazuh_fortinet_alerts_map_effective | length > 0 %}
{% for item in forti_wazuh_fortinet_alerts_map_effective %}
  <rule id="{{ (forti_wazuh_fortinet_alerts_rule_id_base | int) + (loop.index0 * 2) }}" level="{{ item.level | int }}">
    <match>{{ forti_wazuh_fortinet_alerts_match_field_effective }}={{ item.match | string }}</match>
{% if forti_wazuh_ssl_vpn_suppress_map %}
{% for match in forti_wazuh_ssl_vpn_fail_match | default([]) %}
    <not_match>{{ match }}</not_match>
{% endfor %}
{% endif %}
    <description>Fortinet alert level {{ item.level | int }}</description>
  </rule>
  <rule id="{{ (forti_wazuh_fortinet_alerts_rule_id_base | int) + (loop.index0 * 2) + 1 }}" level="{{ item.level | int }}">
    <match>{{ forti_wazuh_fortinet_alerts_match_field_effective }}="{{ item.match | string }}"</match>
{% if forti_wazuh_ssl_vpn_suppress_map %}
{% for match in forti_wazuh_ssl_vpn_fail_match | default([]) %}
    <not_match>{{ match }}</not_match>
{% endfor %}
{% endif %}
    <description>Fortinet alert level {{ item.level | int }}</description>
  </rule>
{% endfor %}
{% else %}
{% for level in forti_wazuh_fortinet_alerts_levels_effective %}
  <rule id="{{ (forti_wazuh_fortinet_alerts_rule_id_base | int) + (loop.index0 * 2) }}" level="{{ level | int }}">
    <match>{{ forti_wazuh_fortinet_alerts_match_field_effective }}={{ level }}</match>
{% if forti_wazuh_ssl_vpn_suppress_map %}
{% for match in forti_wazuh_ssl_vpn_fail_match | default([]) %}
    <not_match>{{ match }}</not_match>
{% endfor %}
{% endif %}
    <description>Fortinet alert level {{ level | int }}</description>
  </rule>
  <rule id="{{ (forti_wazuh_fortinet_alerts_rule_id_base | int) + (loop.index0 * 2) + 1 }}" level="{{ level | int }}">
    <match>{{ forti_wazuh_fortinet_alerts_match_field_effective }}="{{ level }}"</match>
{% if forti_wazuh_ssl_vpn_suppress_map %}
{% for match in forti_wazuh_ssl_vpn_fail_match | default([]) %}
    <not_match>{{ match }}</not_match>
{% endfor %}
{% endif %}
    <description>Fortinet alert level {{ level | int }}</description>
  </rule>
{% endfor %}
{% endif %}
{% if forti_wazuh_ssl_vpn_fail_manage | bool %}
  <rule id="{{ forti_wazuh_ssl_vpn_fail_rule_id_base | int }}" level="{{ forti_wazuh_ssl_vpn_fail_base_level | int }}">
{% for match in forti_wazuh_ssl_vpn_fail_match | default([]) %}
    <match>{{ match }}</match>
{% endfor %}
    <description>Fortinet SSL VPN login fail (suppressed)</description>
  </rule>
{% if forti_wazuh_fortinet_alerts_manage_effective | bool %}
{% set sidns = namespace(list=[]) %}
{% if forti_wazuh_fortinet_alerts_map_effective | length > 0 %}
{% for item in forti_wazuh_fortinet_alerts_map_effective %}
{% set sidns.list = sidns.list + [(forti_wazuh_fortinet_alerts_rule_id_base | int) + (loop.index0 * 2), (forti_wazuh_fortinet_alerts_rule_id_base | int) + (loop.index0 * 2) + 1] %}
{% endfor %}
{% else %}
{% for level in forti_wazuh_fortinet_alerts_levels_effective %}
{% set sidns.list = sidns.list + [(forti_wazuh_fortinet_alerts_rule_id_base | int) + (loop.index0 * 2), (forti_wazuh_fortinet_alerts_rule_id_base | int) + (loop.index0 * 2) + 1] %}
{% endfor %}
{% endif %}
{% if sidns.list | length > 0 %}
  <rule id="{{ (forti_wazuh_ssl_vpn_fail_rule_id_base | int) + 2 }}" level="0">
    <if_sid>{{ sidns.list | join(',') }}</if_sid>
{% for match in forti_wazuh_ssl_vpn_fail_match | default([]) %}
    <match>{{ match }}</match>
{% endfor %}
    <description>Fortinet SSL VPN login fail (suppressed from level mapping)</description>
    <noalert/>
  </rule>
{% endif %}
{% endif %}
  <rule id="{{ (forti_wazuh_ssl_vpn_fail_rule_id_base | int) + 1 }}" level="{{ forti_wazuh_ssl_vpn_fail_level | int }}">
    <if_sid>{{ forti_wazuh_ssl_vpn_fail_rule_id_base | int }}</if_sid>
    <frequency>{{ forti_wazuh_ssl_vpn_fail_frequency | int }}</frequency>
    <timeframe>{{ forti_wazuh_ssl_vpn_fail_timeframe | int }}</timeframe>
{% if forti_wazuh_ssl_vpn_fail_same_field | default('') | trim | length > 0 %}
    <same_field>{{ forti_wazuh_ssl_vpn_fail_same_field }}</same_field>
{% endif %}
    <description>Fortinet SSL VPN login fail ({{ forti_wazuh_ssl_vpn_fail_frequency | int }}+ in {{ forti_wazuh_ssl_vpn_fail_timeframe | int }}s)</description>
  </rule>
{% endif %}
</group>
