\
# Ansible managed: Fortinet/FortiGate syslog receiver
# This file is rendered by roles/forti_rsyslog.
#
# Writes Fortinet syslog to: {{ forti_log_path }}
#
# Notes:
# - Only messages arriving on the configured UDP/TCP port(s) hit the "fortinet" ruleset.
# - Optional sender restriction uses $fromhost-ip checks.

{% if forti_syslog_enable_udp %}
module(load="imudp")
{% endif %}
{% if forti_syslog_enable_tcp %}
module(load="imtcp")
{% endif %}

ruleset(name="fortinet") {
{% if forti_syslog_allowed_senders | length > 0 %}
  # Drop messages from unapproved senders
  if not (
    {%- for ip in forti_syslog_allowed_senders -%}
    $fromhost-ip == "{{ ip }}"{% if not loop.last %} or{% endif %}
    {%- endfor -%}
  ) then {
    stop
  }
{% endif %}

  action(
    type="omfile"
    file="{{ forti_log_path }}"
    template="RSYSLOG_TraditionalFileFormat"
    dirCreateMode="{{ forti_log_dir_mode }}"
    fileCreateMode="{{ forti_log_file_mode }}"
    fileOwner="{{ forti_log_owner }}"
    fileGroup="{{ forti_log_group }}"
    createDirs="on"
  )

  stop
}

{% if forti_syslog_enable_udp %}
# UDP listener
input(
  type="imudp"
  port="{{ forti_syslog_udp_port }}"
  {% if forti_syslog_listen_address | length > 0 -%}
  address="{{ forti_syslog_listen_address }}"
  {%- endif %}
  ruleset="fortinet"
)
{% endif %}

{% if forti_syslog_enable_tcp %}
# TCP listener
input(
  type="imtcp"
  port="{{ forti_syslog_tcp_port }}"
  {% if forti_syslog_listen_address | length > 0 -%}
  address="{{ forti_syslog_listen_address }}"
  {%- endif %}
  ruleset="fortinet"
)
{% endif %}
